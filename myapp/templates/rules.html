{% extends 'base.html' %}
{% block content %}
{% if messages %}
  <ul class="alert-list">
    {% for message in messages %}
      <li class="alert alert-{{ message.tags }}">{{ message|safe }}</li>
    {% endfor %}
  </ul>
{% endif %}
<form method="post" enctype="multipart/form-data" class="form">
  {% csrf_token %}

  <p class="hint">
    ①モードでは、自然言語で「製作種別」に関するルールを記述し、CSVに予測列を追加できます。<br>
    下の入力欄にルールを書いて「コード生成」を押すと、自動で Python コードが生成されます。
  </p>

   <!-- ▼ 参照データ（XREF1/XREF2）対応版の書き方ヘルプ -->
  <details class="hint" style="margin:12px 0;">
    <summary><strong>書き方の注意 & 参照データ（XREF1 / XREF2）の使い方</strong></summary>

    <ul>
      <li><strong>NGワード：</strong><code>import</code> / <code>exec</code> / <code>eval</code> / <code>if</code> / <code>for</code> / <code>while</code> などは使えません（検出時はエラー）。</li>
      <li><strong>分岐方法：</strong><code>prediction.loc[条件 &amp; prediction.isna()] = 'ラベル'</code> の形で記述します。条件は <code>&amp;</code> / <code>|</code> で合成。</li>
      <li><strong>真偽値：</strong>真偽は数値や文字列で表現（例：<code>1</code> / <code>'true'</code> / <code>'yes'</code>）。</li>
      <li><strong>参照データ：</strong><code>XREF1</code> / <code>XREF2</code> は <em>読み取り専用</em>（代入や書換えは不可）。</li>
    </ul>

    <div class="card" style="padding:8px;margin:8px 0;">
      {% if REFERENCE_CSV_01_COLUMNS and REFERENCE_CSV_01_COLUMNS|length > 0 %}
        <details class="mt-2">
          <summary>使用可能な列（固定）</summary>
          <ul>
            {% for c in REFERENCE_CSV_01_COLUMNS %}
              <li><code>{{ c }}</code></li>
            {% endfor %}
          </ul>
        </details>
      {% else %}
        <p class="text-warning">列スキーマが未設定です。環境変数 REFERENCE_CSV_01_COLUMNS_JSON を登録してください。</p>
      {% endif %}
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="card">
        <div><strong>悪い例（NG）</strong></div>
        <pre>if 数量 &gt; 10 なら「製作A」</pre>
      </div>
      <div class="card">
        <div><strong>良い例（OK）</strong></div>
        <pre>数量が10を超え、品目区分が「加工」のとき「部品製作」</pre>
      </div>
    </div>

    <hr style="margin:12px 0;">

    <div class="card" style="padding:8px;">
      <div><strong>サンプル1：vlookup 的マッピング（XREF2 を使う）</strong></div>
      <p class="hint">例：入力の <code>spec_code</code> を XREF2 の <code>class_label</code> に写経して付与</p>
      <pre>
  m = XREF2.lookup_map('spec_code', 'class_label')
  prediction.loc[df['spec_code'].map(m).notna() &amp; prediction.isna()] = df['spec_code'].map(m)
      </pre>
    </div>

    <div class="card" style="padding:8px; margin-top:8px;">
      <div><strong>サンプル2：結合して条件判定（XREF1 を使う）</strong></div>
      <p class="hint">例：入力の <code>part_no</code> を XREF1 の <code>family</code> と突合し、該当なら「製作A」</p>
      <pre>
  _tmp = df.merge(XREF1.df[['part_no', 'family']], on='part_no', how='left')
  prediction.loc[_tmp['family'].eq('A') &amp; prediction.isna()] = '製作A'
      </pre>
    </div>

    <p class="hint" style="margin-top:8px;">
      ※ <code>XREF1</code>/<code>XREF2</code> は読み取り専用です。<code>XREF1[...] = ...</code> や <code>XREF2.xxx = ...</code> は禁止です。
    </p>
  </details>
  <!-- ▲ 参照データ対応ヘルプここまで -->


  <label>自然言語のルール（製作種別に関する条件を記載してください）</label>
  {{ form.natural_language }}

  <div class="actions">
    <button name="action" value="generate_block" class="btn">コード生成</button>
    <a href="/" class="btn-outline">トップに戻る</a>
  </div>

  {% if generated_code %}
    <h3>生成/編集するコード</h3>
    <p class="hint">apply_rules(df) を定義してください</p>
    <textarea name="code_text" rows="18" style="width:100%;font-family:monospace;">{{ generated_code }}</textarea>
    <input type="hidden" name="generated_code" value="{{ generated_code|escape }}">
    <input type="hidden" name="generated_addition" value="{{ generated_addition|default_if_none:''|escape }}">
  {% else %}
    <label>生成/編集するコード</label>
    {{ form.code_text }}
  {% endif %}

  {% if diff_text %}
  <h3>差分プレビュー</h3>
  <pre class="diff">{{ diff_text }}</pre>
  <div class="actions">
    <button type="submit" name="action" value="apply_to_editor" class="btn-outline">差分を適用して最新のコードに反映</button>
  </div>
  {% endif %}

  <label>CSVファイル</label>
  {{ form.csv_file }}

  <div class="actions">
    <button type="submit" name="action" value="apply_and_run" class="btn">最新コードでCSVに適用してダウンロード</button>
    <a href="/" class="btn-outline">トップに戻る</a>
  </div>

  {% if message %}<p class="msg">{{ message }}</p>{% endif %}
  {% if error %}<pre class="err">{{ error }}</pre>{% endif %}
</form>
{% endblock %}
